<!doctype html>
<html>
  <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      
      <title>往网页注入jQuery | 稻草人.L的记录</title>
      <!--<link href="http://fonts.googleapis.com/css?family=Vollkorn&subset=latin" rel="stylesheet" type="text/css">-->
      <link rel="stylesheet" href="/develop-notes/static/style.css" type="text/css">
      <link rel="stylesheet" href="/static/_pygments.css" type="text/css">
      
  </head>
  <body>
      <div class=container>
          <div class=header>
              <a href="/">稻草人.L的记录</a>
          </div>
          <div class=navigation>
              <ul>
                  <li><a href="/develop-notes/">blog</a></li>
                  <li><a href="/develop-notes/archive/">archive</a></li>
                  <li><a href="/develop-notes/tags/">tags</a></li>
                  <li><a href="/develop-notes/feed.atom" rel="alternate" title="Recent Blog Posts">feed</a></li>
              </ul>
          </div>
          <div class=body>
              
  <h1 class="title">往网页注入jQuery</h1>

  
  <p class=date>written on Thursday, October 20, 2011
  

  <p>今天&quot;Scatch my own itch&quot;, 想为微博添加个直接的&quot;Read It Later&quot;功能. 利用书签栏直接运行javascript的方法应该来的通用简单点, 在实现的过程中, 就遇到了这个&quot;Inject&quot;单词.</p>
<p>在书签栏直接运行javascript, 只不过时网址部分更改为javascript, 注意不要带&quot;//&quot;注释. 示例如下:
.. sourcecode:: javascript</p>
<blockquote>
javascript: (function(){alert('ok');})()</blockquote>
<p>因为要继续Dom操作, 而自己较熟悉的是jQuery, 必然要想办法获取jQuery. 而又要确保jQuery加载成功, 就优先想到了利用Google API的 <a class="reference external" href="http://code.google.com/apis/loader/">Loader</a>. (知道其存在, 但一致没用过)</p>
<p>参考其文档上*Dynamic Loading*的示例改写:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">jqueryLoaded</span><span class="p">(){}</span>

<span class="kd">function</span> <span class="nx">loadJQuery</span><span class="p">(){</span>
   <span class="nx">google</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s1">&#39;jquery&#39;</span><span class="p">,</span> <span class="s1">&#39;1.6.4&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;callback&#39;</span><span class="o">:</span> <span class="nx">jqueryLoaded</span><span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">initLoader</span><span class="p">(){</span>
   <span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
   <span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;https://www.google.com/jsapi?key=MYKEY&amp;callback=loadJQuery&#39;</span>
   <span class="nx">script</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;text/javascript&#39;</span><span class="p">;</span>
   <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">script</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>构建书签, 测试:</p>
<pre class="literal-block">
Module: 'jquery' must be loaded before DOM onLoad!
</pre>
<p>改用&quot; google.setOnLoadCallback()也不行. 如果直接在网页上测试, 通过. 最后在StackOver找到 <a class="reference external" href="http://stackoverflow.com/questions/840240/injecting-jquery-into-a-page-fails-when-using-google-ajax-libraries-api">Injecting jQuery into a page fails when using Google AJAX Libraries API</a>, 脱离Google Loader, 直接利用&quot;onlooad, onreadystatechange&quot;事件执行回调.</p>
<div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
     <span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">);</span>
     <span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js&quot;</span><span class="p">;</span>
     <span class="nx">script</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">script</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span> <span class="cm">/* your callback here */</span> <span class="p">};</span>
     <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span> <span class="nx">script</span> <span class="p">);</span>
 <span class="p">})()</span>
</pre></div>
<p>里面的comment也提到 <a class="reference external" href="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js">ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js</a> 能获取到jQuery的最新版本</p>
<p>最后修改的加载实现为:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">loadJQuery</span><span class="p">(</span><span class="nx">cbFunc</span><span class="p">){</span>
   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">jQuery</span><span class="p">){</span>
       <span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
       <span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js&quot;</span><span class="p">;</span>
       <span class="nx">script</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;text/javascript&#39;</span><span class="p">;</span>
       <span class="nx">script</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">script</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">cbFunc</span><span class="p">;</span>
       <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">script</span><span class="p">);</span>
   <span class="p">}</span><span class="k">else</span><span class="p">{</span>
       <span class="nx">cbFunc</span><span class="p">();</span>
   <span class="p">}</span>
<span class="p">};</span>
</pre></div>
<p>至于用Google Loader的方法, 未找到修正实现</p>
<p>(Thu Oct 20 22:48:30 CST 2011)</p>


  

          </div>
          <div class=footer>
              <p>&copy; Copyright 2013 by 稻草人.L
              <p>
              Content licensed under the Creative Commons
              attribution-noncommercial-sharealike License.
              <p>
              联系我: 
	      <span>Tukki.Eta(#)gmail.com</span> &nbsp;
	      <a href="http://twitter.com/scarecrow_L">Twitter</a> &nbsp;
          <a href="https://www.github.com/tukki">Github</></a> &nbsp;
      </div>

          </div>
      </div>
  </body>
</html>
