<!doctype html>
<html>
  <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      
      <title>hosting static website on gae | 稻草人.L的记录</title>
      <!--<link href="http://fonts.googleapis.com/css?family=Vollkorn&subset=latin" rel="stylesheet" type="text/css">-->
      <link rel="stylesheet" href="/develop-notes/static/style.css" type="text/css">
      <link rel="stylesheet" href="/develop-notes/static/pygments.css" type="text/css">
      
  </head>
  <body>
      <div class=container>
          <div class=header>
            <a href="/develop-notes/">稻草人.L的记录</a>
          </div>
          <div class=navigation>
              <ul>
                <li><a href="/develop-notes/archive/">archive</a></li>
                <li><a href="/develop-notes/tags/">tags</a></li>
                <li><a href="/develop-notes/feed.atom" rel="alternate" title="Recent Blog Posts">feed</a></li>
              </ul>
          </div>
          <div class=body>
              
  <h1 class="title">hosting static website on gae</h1>

  
  <p class=date>written on Wednesday, November 30, 2011
  

  <p>起因: 突然想把部署在DotCloud上面的notes迁移到GAE上面. 理由很简单, 冲动.</p>
<dl class="docutils">
<dt>获得:</dt>
<dd>发现GAE新版支持Jinja2
<a class="reference external" href="http://code.google.com/appengine/docs/python/config/appconfig.html">Application　Configuration</a> 比想象中强大.
GAE不支持中文文件名上传.
fork了rstblog进行url生成的修改</dd>
<dt>失去:</dt>
<dd>6+4 小时. 主要时间放在了URL后面的 <em>trailing slash</em> 上面</dd>
</dl>
<div class="section" id="static-files-on-gae">
<h2>Static Files on GAE</h2>
<p>首先是 <a class="reference external" href="http://code.google.com/appengine/docs/python/config/appconfig.html#Static_File_Handlers">官方文档</a>:</p>
<pre class="literal-block">
Static file handlers can be defined in two ways:
  as a directory sturcture of static files that maps to a URL path,
  or as a pattern that maps URLs to specific files.
</pre>
<p>rstblog生成的静态文件结构:</p>
<pre class="literal-block">
2011
  |-- 10
  |   |-- 04
  |   |   |-- first-rstblog-post
  |   |   |   `-- index.html
  |   |   `-- make-rstblog-support-chinese-filename
  |   |   |    `-- index.html
  |   |    `-- index.html
  |   `-- index.html
</pre>
<p>用 <a class="reference external" href="http://code.google.com/appengine/docs/python/config/appconfig.html#Static_Directory_Handlers">Static Directory Handlers</a> 映射这个目录结构. 因为全部都是静态文件, 所以URL就不用前序了:</p>
<pre class="literal-block">
- url: /
  static_dir: rstblog
</pre>
<p>只是这样的话, 只能用完整路径来显示对应的文件. 而当访问一个目录时, 例如 &quot;/2011/11/28/about-the-hacker-news-ranking/&quot;, 实际要显示的是其目录下的&quot;index.html&quot;文件. (rstblog生成的目录都有对应一个&quot;index.html&quot;来显示了该目录下的文件). 这时要用到的是 <a class="reference external" href="http://code.google.com/appengine/docs/python/config/appconfig.html#Static_File_Pattern_Handlers">Static File Pattern Handlers</a>:</p>
<pre class="literal-block">
- url: (.*)/
  static_files: rstblog\1/index.html
      upload: rstblog\1/index.html
</pre>
<p>正则式用的是 <a class="reference external" href="http://en.wikipedia.org/wiki/Regular_expression%23Syntax&amp;usg=__mBDvPGMNbDvCnmh1oLFnVOCuNwI=">POSIX extended regular expression syntax</a>. &quot;以0个或者0个以上的字符&quot;外加&quot;/&quot;结尾的URL, 都认为是目录, 输出其目录下的&quot;index.html&quot;文件内容.</p>
<p>看文档和相关的blog时看上去很简单. 问题却发生在实际执行中. -_-!!</p>
<p>rstblog对于记录的链接生成是不带&quot;/&quot;结尾的. 在DotCloud或者自带的开发服务器上面一直没注意到, 因为都自动加&quot;/&quot;后进行了redirect. 而GAE本来就不是为了部署静态文件用的, 所以不会自动识别并自动重定向. (应该这样理解?). Django也是靠在settings上面制定才会主动帮忙加.</p>
<p>一开始再GAE方面没找到合适的方法, 就去改rstblog的代码. 让生成的链接自动追加&quot;/&quot;.</p>
<p>在github上面fork了rstblog进行修改. <a class="reference external" href="https://github.com/Tukki/rstblog">Here</a>. 其实只是改了其Builder初始化时注册的&quot;page'格式:</p>
<div class="highlight"><pre><span class="c">#self.register_url(&#39;page&#39;, &#39;/&lt;path:slug&gt;&#39;)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">register_url</span><span class="p">(</span><span class="s">&#39;page&#39;</span><span class="p">,</span> <span class="s">&#39;/&lt;path:slug&gt;/&#39;</span><span class="p">)</span>
</pre></div>
<p>6小时结束.</p>
<p>后面四小时属于不满意上面的解决方案. 尝试写个Redirector追加&quot;/&quot;到URL上面.</p>
<p>一直没有理清思路, 也忽略了GAE的handlers配置是带先后顺序的, 匹配后就不再往下尝试. 于是发生了痛苦的事情.</p>
<p>问题在于如何匹配不是指向最终文件的URL, 然后执行script追加&quot;/&quot;.</p>
<p>找到的示例都是带前序的, 有明确的pattern. 当rstblog生成的目录结构不适合这样, 也不想重构这个目录结构. 一直在试错, 最后简单点, 确定规则: 只要URI上面不带&quot;.&quot;的, 都进行重定向:</p>
<pre class="literal-block">
- url: /([^\.]*)
  script: redirector.app
</pre>
<p>用的是redirector用的是webapp2:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">webapp2</span>

<span class="k">class</span> <span class="nc">RedirectorHandler</span><span class="p">(</span><span class="n">webapp2</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
       <span class="k">assert</span> <span class="ow">not</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">path</span>
       <span class="n">path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">webapp2</span><span class="o">.</span><span class="n">WSGIApplication</span><span class="p">([</span>
    <span class="p">(</span><span class="s">&#39;(.*)&#39;</span><span class="p">,</span> <span class="n">RedirectorHandler</span><span class="p">),</span>  <span class="c">#直接匹配所有.</span>
<span class="p">],</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
<p>然后是app.yaml</p>
<div class="highlight"><pre><span class="l-Scalar-Plain">application</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">scarecrow-notes</span>
<span class="l-Scalar-Plain">version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
<span class="l-Scalar-Plain">runtime</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">python27</span>
<span class="l-Scalar-Plain">api_version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
<span class="l-Scalar-Plain">threadsafe</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>

<span class="l-Scalar-Plain">handlers</span><span class="p-Indicator">:</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">(.*)/</span>
  <span class="l-Scalar-Plain">static_files</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rstblog\1/index.html</span>
      <span class="l-Scalar-Plain">upload</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rstblog(.*)/index.html</span>

<span class="c1">#不带&quot;.&quot;的路径进入redirect状态</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/([^\.]*)</span>
  <span class="l-Scalar-Plain">script</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">redirector.app</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/</span>
  <span class="l-Scalar-Plain">static_dir</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rstblog</span>
</pre></div>
<p>update一下, 可行. 写记录再花4小时... 真少不了折腾.</p>
<p>&lt;!-- Wed Nov 30 23:59:51 CST 2011 --&gt;</p>
<p>Useful links:</p>
<ul>
<li><dl class="first docutils">
<dt><a class="reference external" href="http://www.instantfundas.com/2011/02/how-to-host-static-websites-on-google.html">How to Host Static Websites on Google App Engine for Free</a></dt>
<dd><p class="first last">里面提到的是windows环境下</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><a class="reference external" href="http://blog.engelke.com/2008/07/30/google-appengine-for-web-hosting/">Google AppEngine for web hosting</a></dt>
<dd><p class="first last">这个只是没处理无&quot;/&quot;的情况</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><a class="reference external" href="https://gist.github.com/873098">App.yaml designed for serving a static site on Google App Engine (Python).</a></dt>
<dd><p class="first last">超详细的配置文件... 指定了各种类型</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><a class="reference external" href="http://blog.engelke.com/2008/07/31/appengine-rewrite-rules/">AppEngine “Rewrite Rules”</a></dt>
<dd><p class="first last">redirector的火花从这里爆发</p>
</dd>
</dl>
</li>
</ul>
</div>


  
  <p class=tags>This entry was tagged
    
      <a href="/develop-notes/tags/gae/">gae</a> and 
      <a href="/develop-notes/tags/python/">python</a>
  

          </div>
          <div class=footer>
              <p>&copy; Copyright 2013 by 稻草人.L
              <p>
              Content licensed under the Creative Commons
              attribution-noncommercial-sharealike License.
              <p>
              联系我: 
	      <span>Tukki.Eta(#)gmail.com</span> &nbsp;
        <a href="http://twitter.com/scarecrow_L">Twitter</a> &nbsp;
        <a href="https://www.github.com/tukki">Github</></a> &nbsp;
        <a href="http://weibo.com/liuyuzh">新浪微博</></a> &nbsp;
      </div>

          </div>
      </div>
  </body>
</html>
