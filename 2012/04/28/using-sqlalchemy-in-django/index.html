<!doctype html>
<html>
  <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      
      <title>Using SQLAlchemy in Django | 稻草人.L的记录</title>
      <!--<link href="http://fonts.googleapis.com/css?family=Vollkorn&subset=latin" rel="stylesheet" type="text/css">-->
      <link rel="stylesheet" href="/static/style.css" type="text/css">
      <link rel="stylesheet" href="/static/_pygments.css" type="text/css">
      
  </head>
  <body>
      <div class=container>
          <div class=header>
              <a href="/">稻草人.L的记录</a>
          </div>
          <div class=navigation>
              <ul>
                  <li><a href="/">blog</a></li>
                  <li><a href="/archive/">archive</a></li>
                  <li><a href="/tags/">tags</a></li>
                  <li><a href="/feed.atom" rel="alternate" title="Recent Blog Posts">feed</a></li>
              </ul>
          </div>
          <div class=body>
              
  <h1 class="title">Using SQLAlchemy in Django</h1>

  
  <p class=date>written on Saturday, April 28, 2012
  

  <p>现在的工程还是基于Django, 不过ORM部分已经确认用SQLAlchemy了. 现在也建了一层DAL来管理数据非业务相关的实现, 看接口定义, 有点像让粒度小一点. 提供复用</p>
<pre class="literal-block">
UserDAL.get_user_by_id(id)
ActionDAL.action(user_id, value)
</pre>
<p>首先有个想法, 想让Session在request-response周期内自动管理transcations, 自然得动用Middleware. 有点懒, 直接上代码(未完整测试).</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.utils.functional</span> <span class="kn">import</span> <span class="n">SimpleLazyObject</span>
<span class="kn">from</span> <span class="nn">somewhere</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="k">def</span> <span class="nf">get_dbSession</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;_cached_dbSession&#39;</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">_cached_dbSession</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
        <span class="c">#http://docs.sqlalchemy.org/en/latest/orm/session.html#committing</span>
        <span class="c">#In autocommit mode, a transaction can be initiated by calling the begin() method.</span>
        <span class="n">request</span><span class="o">.</span><span class="n">_cached_dbSession</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">_cached_dbSession</span>

<span class="k">def</span> <span class="nf">has_dbSession</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;_cached_dbSession&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SQLAlchemySessionMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">dbSession</span> <span class="o">=</span> <span class="n">SimpleLazyObject</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">get_dbSession</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">has_dbSession</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="n">dbSession</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbSession</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dbSession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">dbSession</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">process_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">has_dbSession</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
           <span class="n">dbSession</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dbSession</span>
           <span class="n">dbSession</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</pre></div>
<p>用了SimpleLazyObject来管理request.dbSession是考虑到并非每个request都会用到dbSession, 就直接懒惰处理.</p>
<p>像是解决问题了.</p>
<p>两个困惑. 1)是不是需要用request.dbSession初始化DAL/参数传入; 2)如果不传值, 如何做到DALs上面能共用一个Session上下文.</p>
<p>记得以前用Pyramid的时候也有遇到这个情况. 只是没总结好. 今晚回来好好查了下SQLAlchemy的文档, 找到似曾相似的 <a class="reference external" href="http://docs.sqlalchemy.org/en/latest/orm/session.html#contextual-thread-local-sessions">Contextual/Thread-local Sessions</a>, 使用scoped_session:</p>
<pre class="literal-block">
By default, this context is the current thread.
</pre>
<p>查查已有实现, 才发现现在定义的Session只是sessionmaker()出来. 改用scoped_session, 上面两个疑惑一并解决了吧.</p>
<p>如果不是dbSession.begin(). 应该会忽略以下一个问题: 这个Middleware是否导致Session的Transaction太长了? 而且transaction的使用也不灵活. 再者, scoped_session的使用, 已经可以让整个Middleware实现无用化, 用错方法来解决问题了.</p>
<p>现在想, 或在一个view级别的decorators足够了, django.db.transaction.commit_on_success. 再者, 过度设计了. 现在的系统需要用到transaction了吗?</p>
<p>&lt;Sat Apr 28 02:07:45 CST 2012&gt;</p>


  
  <p class=tags>This entry was tagged
    
      <a href="/tags/django/">django</a>, 
      <a href="/tags/failure/">failure</a>, 
      <a href="/tags/python/">python</a> and 
      <a href="/tags/sqlalchemy/">sqlalchemy</a>
  

          </div>
          <div class=footer>
              <p>&copy; Copyright 2013 by 稻草人.L
              <p>
              Content licensed under the Creative Commons
              attribution-noncommercial-sharealike License.
              <p>
              联系我: 
	      <span>Tukki.Eta(#)gmail.com</span> &nbsp;
	      <a href="http://twitter.com/scarecrow_L">Twitter</a> &nbsp;
          <a href="https://www.github.com/tukki">Github</></a> &nbsp;
      </div>

          </div>
      </div>
  </body>
</html>
