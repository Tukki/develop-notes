<!doctype html>
<html>
  <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      
      <title>python requests 设置POST编码方式 | 稻草人.L的记录</title>
      <!--<link href="http://fonts.googleapis.com/css?family=Vollkorn&subset=latin" rel="stylesheet" type="text/css">-->
      <link rel="stylesheet" href="/develop-notes/static/style.css" type="text/css">
      <link rel="stylesheet" href="/develop-notes/static/pygments.css" type="text/css">
      
  </head>
  <body>
      <div class=container>
          <div class=header>
            <a href="/develop-notes/">稻草人.L的记录</a>
          </div>
          <div class=navigation>
              <ul>
                <li><a href="/develop-notes/archive/">archive</a></li>
                <li><a href="/develop-notes/tags/">tags</a></li>
                <li><a href="/develop-notes/feed.atom" rel="alternate" title="Recent Blog Posts">feed</a></li>
              </ul>
          </div>
          <div class=body>
              
  <h1 class="title">python requests 设置POST编码方式</h1>

  
  <p class=date>written on Sunday, September 2, 2012
  

  <p>源于一个使用的错误, 然后挖了一下requests的源码.</p>
<p>想用requests发个带图片的微博. 要用到 <a class="reference external" href="http://open.weibo.com/wiki/2/statuses/upload">upload</a> 接口, 注意事项时使用&quot;multipart/form-data&quot;编码方式.</p>
<p>先是按其文档上面的说明, 使用files的方式进行文件发送</p>
<!-- sourcecode: python

>>> files = {'file': ('pic', open('test.jpg', 'rb'))}
>>> r = requests.post(url, data=data, files=files) -->
<p>返回错误. 以为必需把pic放到data里面进行发送. 该过来尝试了一次. 报headers不支持. <a class="reference external" href="http://docs.python-requests.org/en/latest/user/quickstart/#custom-headers">支持Custom Headers</a>:</p>
<pre class="literal-block">
&gt;&gt;&gt; headers = {'content-type': 'multipart/form-data'}
&gt;&gt;&gt; r = requests.post(url, data=data, headers=headers)
</pre>
<p>还是不行. 散弹式寻找答案, 甚至以为要自己 <a class="reference external" href="http://code.activestate.com/recipes/146306-http-client-to-post-using-multipartform-data/">设置BOUNDARY</a>. 不过这样就不像Requests了.</p>
<p>在requests的 <a class="reference external" href="https://github.com/kennethreitz/requests/issues/737">issues</a> 看到这样一个示例:</p>
<pre class="literal-block">
&gt;&gt;&gt; print post('http://httpbin.org/post', data={'X': 'a'}, files={'X': open('/etc/hosts')}).content
</pre>
<p>原来最开始的错误只是... 用错方式来指定文件的名字了?</p>
<blockquote>
<pre class="doctest-block">
&gt;&gt;&gt; files = {'pic': open('test.jpg', 'rb')}
</pre>
</blockquote>
<p>再post就可以了. 成功发送图片微博</p>
<p>于是想看看requests这部分的实现是怎样的. 在models.py里面的send函数:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
    <span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">content_type</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">builtin_str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">):</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;application/x-www-form-urlencoded&#39;</span>

<span class="c"># Add content-type if it wasn&#39;t explicitly provided.</span>
<span class="k">if</span> <span class="p">(</span><span class="n">content_type</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="s">&#39;content-type&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content_type</span>
</pre></div>
<p>在有files字段的时候调用的_encode_file会encode_multipart_formdata. 而只有data情况下, 使用的是 urlencode, 并且把content_type设为&quot;application/x-www-form-urlencoded&quot;.</p>
<p>这就解析了为什么我把pic放到data里面, 并强制设置headers都不行.. 得到的headers值根本就是不符合规定的.</p>


  

          </div>
          <div class=footer>
              <p>&copy; Copyright 2013 by 稻草人.L
              <p>
              Content licensed under the Creative Commons
              attribution-noncommercial-sharealike License.
              <p>
              联系我: 
	      <span>Tukki.Eta(#)gmail.com</span> &nbsp;
        <a href="http://twitter.com/scarecrow_L">Twitter</a> &nbsp;
        <a href="https://www.github.com/tukki">Github</></a> &nbsp;
        <a href="http://weibo.com/liuyuzh">新浪微博</></a> &nbsp;
      </div>

          </div>
      </div>
  </body>
</html>
