<!doctype html>
<html>
  <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      
      <title>using sequence to generate global_id | 稻草人.L的记录</title>
      <!--<link href="http://fonts.googleapis.com/css?family=Vollkorn&subset=latin" rel="stylesheet" type="text/css">-->
      <link rel="stylesheet" href="/static/style.css" type="text/css">
      <link rel="stylesheet" href="/static/_pygments.css" type="text/css">
      
  </head>
  <body>
      <div class=container>
          <div class=header>
              <a href="/">稻草人.L的记录</a>
          </div>
          <div class=navigation>
              <ul>
                  <li><a href="/">blog</a></li>
                  <li><a href="/archive/">archive</a></li>
                  <li><a href="/tags/">tags</a></li>
                  <li><a href="/feed.atom" rel="alternate" title="Recent Blog Posts">feed</a></li>
              </ul>
          </div>
          <div class=body>
              
  <h1 class="title">using sequence to generate global_id</h1>

  
  <p class=date>written on Saturday, May 25, 2013
  

  <p>使用 <a class="reference external" href="http://www.postgresql.org/docs/9.2/interactive/sql-createsequence.html">Postgresql Sequence</a> 作为global_id生成器</p>
<div class="highlight"><pre><span class="k">select</span> <span class="n">nextval</span><span class="p">(</span><span class="s1">&#39;seq&#39;</span><span class="p">);</span>
</pre></div>
<p>如果也需要预加载id到应用层, 可以使用 next_id = select setval('seq', currval('seq')+10);</p>
<p>同事的mysql版本:</p>
<div class="highlight"><pre><span class="k">Create</span> <span class="k">Table</span><span class="p">:</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">ss_id_generator</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">next_id</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="n">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
   <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">next_id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">MyISAM</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">10000008501</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">latin1</span>
</pre></div>
<p>使用的是 LAST_INSERT_ID 进行id管理, 并预加载id到应用层缓冲. 还需要注意应用层资源管理, 加锁.</p>
<div class="highlight"><pre><span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s">&quot;update ss_id_generator set next_id=LAST_INSERT_ID(next_id+</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_count</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select LAST_INSERT_ID() as next_id&quot;</span><span class="p">)</span>
<span class="n">next_id</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="n">next_id</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_fetch_count</span><span class="p">,</span> <span class="n">next_id</span><span class="p">)</span>
</pre></div>
<dl class="docutils">
<dt>global_id 不应该rollback.</dt>
<dd><ul class="first last simple">
<li>用mysql实现, 尽量用myisam, 用innodb是可以rollback的.</li>
<li>用postgresql的Sequence, non-transactional.</li>
</ul>
</dd>
<dt>用Sequence不用写应用层优化多取id避免数据库读写频繁, 带cache选项</dt>
<dd>the optional clause CACHE cache specifies how many sequence numbers are to be preallocated and stored in memory for faster access. The minimum value is 1 (only one value can be generated at a time, i.e., no cache), and this is also the default.</dd>
</dl>
<p>用mysql的版本, 需要在应用层缓存多个id, 然后利用线程锁管理. 实现起来麻烦度增加.</p>
<p>使用Sequence也避免了mysql版本导致的id浪费. (N个实例有N*m(缓冲数)个id预生成)</p>
<dl class="docutils">
<dt>Sequence也可以一次取多个出来缓存. 也有更强大但复杂的版本</dt>
<dd>select nextval('seq') from generate_series(1, 1000);</dd>
</dl>
<p>如果用PostgreSQL做db backend, 用Sequence跨表, 无需应用层协助.</p>
<div class="highlight"><pre><span class="k">CREATE</span> <span class="n">SEQUENCE</span> <span class="n">common_fruit_id_seq</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">apples</span> <span class="p">(</span>
    <span class="n">id</span>      <span class="n">INT4</span> <span class="k">DEFAULT</span> <span class="n">nextval</span><span class="p">(</span><span class="s1">&#39;common_fruit_id_seq&#39;</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">price</span>   <span class="nb">NUMERIC</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">oranges</span> <span class="p">(</span>
     <span class="n">id</span>      <span class="n">INT4</span> <span class="k">DEFAULT</span> <span class="n">nextval</span><span class="p">(</span><span class="s1">&#39;common_fruit_id_seq&#39;</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
     <span class="n">weight</span>  <span class="nb">NUMERIC</span>
<span class="p">);</span>
</pre></div>
<p>mysql 记录数据 + postgreql sequence global_id 组合也不错. 各司其职</p>
<p>有用的链接:</p>
<p><a class="reference external" href="http://www.postgresql.org/docs/9.2/interactive/sql-createsequence.html">PostgreSQL create sequence</a></p>
<p><a class="reference external" href="http://www.depesz.com/2008/03/20/getting-multiple-values-from-sequences/">getting multiple values from sequences</a></p>
<p><a class="reference external" href="http://www.neilconway.org/docs/sequences/">FAQ: Using Sequences in PostgresSQL</a></p>


  

          </div>
          <div class=footer>
              <p>&copy; Copyright 2013 by 稻草人.L
              <p>
              Content licensed under the Creative Commons
              attribution-noncommercial-sharealike License.
              <p>
              联系我: 
	      <span>Tukki.Eta(#)gmail.com</span> &nbsp;
	      <a href="http://twitter.com/scarecrow_L">Twitter</a> &nbsp;
          <a href="https://www.github.com/tukki">Github</></a> &nbsp;
      </div>

          </div>
      </div>
  </body>
</html>
