<!doctype html>
<html>
  <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      
      <title>使rstblog支持中文名的rst文件 | 稻草人.L的记录</title>
      <!--<link href="http://fonts.googleapis.com/css?family=Vollkorn&subset=latin" rel="stylesheet" type="text/css">-->
      <link rel="stylesheet" href="/static/style.css" type="text/css">
      <link rel="stylesheet" href="/static/_pygments.css" type="text/css">
      
  </head>
  <body>
      <div class=container>
          <div class=header>
              <a href="/">稻草人.L的记录</a>
          </div>
          <div class=navigation>
              <ul>
                  <li><a href="/">blog</a></li>
                  <li><a href="/archive/">archive</a></li>
                  <li><a href="/tags/">tags</a></li>
                  <li><a href="/feed.atom" rel="alternate" title="Recent Blog Posts">feed</a></li>
              </ul>
          </div>
          <div class=body>
              
  <h1 class="title">使rstblog支持中文名的rst文件</h1>

  
  <p class=date>written on Tuesday, October 4, 2011
  

  <p>本人使用的系统环境, Fedora 14, LANG设定en_us.UTF-8. 安装的是 <a class="reference external" href="https://github.com/mitsuhiko/rstblog">github</a>
上rstblog的最新版本(commit 90ca1426a2). 如果以中文作为rst文件名(像本文), 在build时会抛出异常:</p>
<pre class="literal-block">
File &quot;/home/lazy/.virtualenvs/rstblog/lib/python2.7/site-packages
/Werkzeug-0.8.1-py2.7.egg/werkzeug/contrib/atom.py&quot;, line 309, in generate
yield u'  &lt;id&gt;%s&lt;/id&gt;\n' % escape(self.id)
UnicodeDecodeError: 'ascii' codec can't decode byte 0xe4 in position 33:
 ordinal not in range(128)
make: *** [build] Error 1
</pre>
<p>根据trace信息可以知道时Werkzeug在生成Atom时抛的错误. 查看源码, 可以知道entry时Werkzeug.atom.FeedEntry的实例, 其在初始化的时候, 如果没找到id值, 就使用url作为id值. 而rstblog是使用slug作为其url的. 这样一来, 找到修改可能了</p>
<p>找到rstblog.builder.Context. 文档说是&quot;Per rendering information&quot;, 初始化就带了source_filename. 估计修改这里比较安全(未对rstblog的源码通读). <strong>注意下面的修改方式只能证明在我的Fedoar下能行, 不确保是否完全正确, 或在其他平台也能用</strong></p>
<p>修改方式为把source_filename再decode一次. 因为是系统上的文件, 所以可以用sys.getfilesystemencoding()获取编码方式:</p>
<div class="highlight"><pre><span class="c">#place in builder.py</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">default_encode</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">()</span>

<span class="c">#in Context.__init__()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">source_filename</span> <span class="o">=</span> <span class="n">source_filename</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">default_encode</span><span class="p">)</span>
</pre></div>
<p>再run_rstblog build一次, 这次没有报错.在debug_serve下测试页成功显示. 至于生成的atom是否能正确使用, 需部署到外网后再做验证</p>
<dl class="docutils">
<dt>edit:</dt>
<dd>因为想部署到GAE, 而GAE不支持中文文件名, 也没确定是否有方法. so, 遵守游戏规则, 改回英文名
Wed Nov 30 02:05:03 CST 2011</dd>
</dl>


  
  <p class=tags>This entry was tagged
    
      <a href="/tags/python/">python</a> and 
      <a href="/tags/rstblog/">rstblog</a>
  

          </div>
          <div class=footer>
              <p>&copy; Copyright 2013 by 稻草人.L
              <p>
              Content licensed under the Creative Commons
              attribution-noncommercial-sharealike License.
              <p>
              联系我: 
	      <span>Tukki.Eta(#)gmail.com</span> &nbsp;
	      <a href="http://twitter.com/scarecrow_L">Twitter</a> &nbsp;
          <a href="https://www.github.com/tukki">Github</></a> &nbsp;
      </div>

          </div>
      </div>
  </body>
</html>
